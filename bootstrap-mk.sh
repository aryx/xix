#!/bin/sh
# Script to compile 'mk' (and 'rc') without using 'mk' (nor 'rc') and generate
# a bin/mk (and bin/rc) so that we don't need a BOOTSTRAP/Linux/386/bin/mk like
# in kencc. Note that kencc has no BOOTSTRAP/Linux/386/bin/rc because
# it assumes the presence of a shell and can work with both 'rc' and 'sh'.
#
# Note that right now to boostrap Xix we still need:
#  - OCaml with ocamlc, ocamllex, ocamlyacc
#    (LATER: we could bootstrap and use the xix ocamllex/ocamlyacc)
#  - a C compiler
#  - the ocamlfind tool and stdcompat library
#  - /bin/sh
#    (LATER: we could use the xix rc at some point and add it in BOOTSTRAP/)
#  - probably many other things
#
# LATER: Maybe at some point the assembler/linker/compiler in this repo will
# be able to bootstrap itself and we will just need ocamlrun and bytecode
# versions of those tools in BOOTSTRAP/.
#
# This file was mostly auto-generated by copy-pasting a trace of mk.

# any error should abort the script
set -e
# for showing the executed commands (verbose)
set -x

#use_ocaml_light="yes"

if test "$use_ocaml_light" = "yes"; then
    EXTERNAL_LIB="."
else    
    # Limit to just stdcompat! This is Xix!
    EXTERNAL_LIB=`ocamlfind query stdcompat`
fi    

#coupling: mkconfig COMPFLAGS
OCAMLCFLAGS="-I $EXTERNAL_LIB -g"

#coupling: mkconfig LINKFLAGS
if test "$use_ocaml_light" = "yes"; then
    EXTRALINKFLAGS="-cclib -lunix -cclib -lstr -custom -g"
else    
    EXTRALINKFLAGS="-I $EXTERNAL_LIB stdcompat.cma -custom -g"
fi    

# can be useful to bench bytecode vs native, see how long it takes to
# run this script with and without .opt
# time: 1.135s with .opt, 1.171 without for 4.09.1. hmmm, not that useful
#OPT=.opt

TOP=`pwd`


cd $TOP/lib_core/collections/
ocamlc$OPT $OCAMLCFLAGS -c Set_.mli
ocamlc$OPT $OCAMLCFLAGS -c Map_.mli
ocamlc$OPT $OCAMLCFLAGS -c Set_.ml
ocamlc$OPT $OCAMLCFLAGS -c Map_.ml
ocamlc$OPT  Set_.cmo Map_.cmo -a -o lib.cma

cd $TOP/lib_core/commons/
ocamlc$OPT $OCAMLCFLAGS -c Cap.mli
ocamlc$OPT $OCAMLCFLAGS -c Dumper.mli
ocamlc$OPT $OCAMLCFLAGS -c Console.mli
ocamlc$OPT $OCAMLCFLAGS -c UConsole.mli
ocamlc$OPT $OCAMLCFLAGS -c Common.mli
ocamlc$OPT $OCAMLCFLAGS -c common2.ml
ocamlc$OPT $OCAMLCFLAGS -c IO.mli
ocamlc$OPT $OCAMLCFLAGS -c Logs.mli
ocamlc$OPT $OCAMLCFLAGS -c Fpath.mli
ocamlc$OPT $OCAMLCFLAGS -c Fpath.ml
ocamlc$OPT $OCAMLCFLAGS -c Fpath_.mli
ocamlc$OPT $OCAMLCFLAGS -c Fpath_.ml
ocamlc$OPT $OCAMLCFLAGS -c Chan.ml
ocamlc$OPT $OCAMLCFLAGS -c UChan.mli
ocamlc$OPT $OCAMLCFLAGS -c CapFS.mli
ocamlc$OPT $OCAMLCFLAGS -c Date.mli
ocamlc$OPT $OCAMLCFLAGS -c Cap.ml
ocamlc$OPT $OCAMLCFLAGS -c CapStdlib.ml
ocamlc$OPT $OCAMLCFLAGS -c CapSys.ml
ocamlc$OPT $OCAMLCFLAGS -c CapUnix.ml
ocamlc$OPT $OCAMLCFLAGS -c Dumper.ml
ocamlc$OPT $OCAMLCFLAGS -c Common.ml
ocamlc$OPT $OCAMLCFLAGS -c Console.ml
ocamlc$OPT $OCAMLCFLAGS -c UConsole.ml
ocamlc$OPT $OCAMLCFLAGS -c CapConsole.ml
ocamlc$OPT $OCAMLCFLAGS -c OCaml.mli
ocamlc$OPT $OCAMLCFLAGS -c Logs.ml
ocamlc$OPT $OCAMLCFLAGS -c UChan.ml
ocamlc$OPT $OCAMLCFLAGS -c CapFS.ml
ocamlc$OPT $OCAMLCFLAGS -c Date.ml
ocamlc$OPT $OCAMLCFLAGS -c IO.ml
ocamlc$OPT $OCAMLCFLAGS -c OCaml.ml
ocamlc$OPT -I . Dumper.cmo Cap.cmo CapStdlib.cmo CapSys.cmo CapUnix.cmo Console.cmo UConsole.cmo CapConsole.cmo Common.cmo common2.cmo OCaml.cmo IO.cmo Logs.cmo Fpath.cmo Fpath_.cmo UChan.cmo CapFS.cmo Date.cmo -a -o lib.cma

cd $TOP/mk
ocamlyacc Parser.mly
ocamllex Lexer.mll
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Globals.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Flags.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Ast.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Shellenv.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Percent.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c File.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Shellenv.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Shell.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Env.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parser.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parse.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Percent.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Rules.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c File.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Shell.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Env.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parser.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Lexer.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Eval.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Graph.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parse.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Eval.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Graph.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Job.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Outofdate.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Scheduler.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Scheduler.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Outofdate.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Main.ml
ocamlc$OPT $EXTRALINKFLAGS -I ../lib_core/commons -I ../lib_core/collections str.cma unix.cma ../lib_core/collections/lib.cma ../lib_core/commons/lib.cma Globals.cmo Flags.cmo Ast.cmo Parser.cmo Lexer.cmo Parse.cmo Shellenv.cmo Shell.cmo Percent.cmo Env.cmo Rules.cmo Eval.cmo File.cmo Graph.cmo Job.cmo Scheduler.cmo Outofdate.cmo Main.cmo ../lib_core/collections/lib.cma ../lib_core/commons/lib.cma -o mk

cd $TOP/shell/
ocamlyacc Parser.mly
ocamllex Lexer.mll
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Flags.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Globals.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Ast.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Opcode.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Pattern.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Prompt.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Status.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Path.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Process.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Error.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Builtin.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Meta_ast.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parser.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parse.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Runtime.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Meta_opcode.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Dumper_.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Compile.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Runtime.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Interpreter.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Pattern.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parser.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Dumper_.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Compile.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Fn.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Var.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Process.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Error.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Lexer.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Op_process.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Fn.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Var.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Prompt.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Status.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Path.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Builtin.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Op_repl.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c CLI.mli
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c CLI.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Main.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Parse.ml
ocamlc$OPT $OCAMLCFLAGS -I ../lib_core/commons -I ../lib_core/collections -c Interpreter.ml
ocamlc$OPT $EXTRALINKFLAGS -I ../lib_core/commons -I ../lib_core/collections str.cma unix.cma ../lib_core/collections/lib.cma ../lib_core/commons/lib.cma Flags.cmo Globals.cmo Ast.cmo Meta_ast.cmo Opcode.cmo Meta_opcode.cmo Dumper_.cmo Compile.cmo Runtime.cmo Pattern.cmo Fn.cmo Var.cmo Prompt.cmo Status.cmo Path.cmo Process.cmo Error.cmo Parser.cmo Lexer.cmo Parse.cmo Builtin.cmo Op_repl.cmo Op_process.cmo Interpreter.cmo CLI.cmo Main.cmo ../lib_core/collections/lib.cma ../lib_core/commons/lib.cma -o rc

cd $TOP
cp mk/mk shell/rc bin/
echo 'Copy bin/mk bin/rc somewhere in your PATH and sets MKSHELL to point to rc.'
